
# E_HOME=/Applications/eclipse
# E_HOME=/Applications/eclipse-SDK-3.2

BRANCH=lawley-build
REVISION=4
E_HOME=/usr/local/lib/eclipse-devel
#E_HOME=/usr/local/eclipse

E_PLUGINS=${E_HOME}

#  Need to be smarter about launching Eclipse (see compile target) when there's and extra plugin dir
#
## E_PLUGINS=${HOME}/Documents/Eclipse-Plugins/eclipse

ifndef BRANCH
BRANCH=lawley
endif

ifdef REVISION
ifneq (${REVISION},HEAD)
COMP_FLAGS=-DforceContextQualifier=${BRANCH}${REVISION} -DbuildLabel=${BRANCH}${REVISION} -DbuildId=${BRANCH}${REVISION}
endif
else
REVISION=HEAD
endif

#BOOTCLASSPATH=-Dbootclasspath=/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/charsets.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/classes.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/dt.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/jce.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/jconsole.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/jsse.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/laf.jar:/System/Library/Frameworks/JavaVM.framework/Versions/1.5.0/Home/../Classes/ui.jar

default: build

init:
	[ ! -d local-update-site ] || rm -rf local-update-site
	rm -rf ~/eclipse.build
	mkdir -p ~/eclipse.build/plugins
	mkdir -p ~/eclipse.build/features

source: \
	plugins/tefkat.config \
	plugins/tefkat.config.edit \
	plugins/tefkat.config.editor \
	plugins/tefkat.model \
	plugins/tefkat.model.edit \
	plugins/tefkat.model.editor \
	plugins/tefkat.model.parser \
	plugins/tefkat.engine \
	plugins/tefkat.plugin \
	features/tefkat.feature \
	runAntlr 

runAntlr:
	(cd ~/eclipse.build/plugins/tefkat.model.parser/src/tefkat/model/parser ; java -cp ${E_PLUGINS}/plugins/org.antlr_2.7.6/antlr.jar antlr.Tool tefkat.g)

build: init source compile local-update-site

compile:
	java -cp ${E_HOME}/startup.jar org.eclipse.core.launcher.Main -application org.eclipse.pde.build.Build -Dbase=${E_HOME} -DbaseLocation=${E_HOME} ${BOOTCLASSPATH} ${COMP_FLAGS}

vcompile:
	java -cp ${E_HOME}/startup.jar org.eclipse.core.launcher.Main -application org.eclipse.pde.build.Build -Dbase=${E_HOME} -DbaseLocation=${E_HOME} ${BOOTCLASSPATH} -verbose ${COMP_FLAGS}

plugins/tefkat.%: ../tefkat.%
	mkdir -p ~/eclipse.build/$@
	(cd ../`basename $@` && git archive ${BRANCH} | (cd ~/eclipse.build/$@ && tar xfp -))

features/tefkat.%: ../tefkat.%
	mkdir -p ~/eclipse.build/$@
	(cd ../`basename $@` && git archive ${BRANCH} | (cd ~/eclipse.build/$@ && tar xfp -))

local-update-site:
	mkdir -p local-update-site
	cp ~/eclipse.build/${BRANCH}${REVISION}/tefkat.feature-${BRANCH}${REVISION}.zip local-update-site/.
	(cd local-update-site && unzip tefkat.feature-${BRANCH}${REVISION}.zip) 
